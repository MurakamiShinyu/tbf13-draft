# Vivliostyle Pubがフォントを扱う仕組み

小形克宏（一般社団法人ビブリオスタイル理事）

## はじめに

Vivliostyle Pub[^1]は、「誰でもCSS組版を楽しめるプロダクト」を目指して開発されたWebアプリだ。面倒なインストールやコマンドラインによる操作は不要、ネットに{繫|つな}がったブラウザさえあればCSS組版で本を作ることができる。一昨年から開発が進められてきたが、ようやく今年4月にアルファ版を公開するところまできた。まだまだ開発途中ではあるが、一人でも多くのユーザーに使っていただき、可能ならフィードバックしてもらえるとありがたい[^2]。

![図1 アルファ版公開がはじまったVivliostyle Pub](./image/fig-1.png){width=400}

さて、そのVivliostyle Pubだが、組版エンジン（Vivliostyle.js[^3]）がプレビュー用はローカル、PDF出力用はクラウドという具合いに、別々の場所に実装されている。その仕組みは後で詳しく述べるが、このようにした理由はユーザーの使い心地に直結するプレビュー表示を、少しでも早くしたかったからだ[^4]。

ところが、組版エンジンを分離させた結果、ユーザーが意識しないままプレビューとPDF出力とでフォントが食い違うことが起こり得るようになった。もし両者のフォントが違えば、プレビューとPDF出力とで行数やページ数が違ってしまう。

とはいえ、食い違ったと言っても、それはローカル環境の場合はCSSにおける`font-family`の指定、クラウドの場合はLinuxのfontconfigの指定によりフォールバックした結果であり、規定の動作にすぎない。それでも、同人誌印刷では1ページ違えば印刷料金が変わることもある。プレビューとPDF出力でページが異なることが分かれば、ユーザーはVivliostyle Pubに不信感を抱くだろう。

この問題はいずれ解決するべきとは思うが、アーキテクチャの深い部分に関わるものであり、すぐには無理と思われる。本稿ではVivliostyle Pubがどのようにフォントを扱っているのかを詳しく説明する。これによりユーザーの混乱を少しでも防ぎ、より多くの人にVivliostyle Pubを使ってもらえればと思う。少しの間、お付き合いいただければ幸いだ。

なお、本稿の内容は、筆者が主に担当した「Vivliostyle Pubユーザーガイド」[^5]の一部を、読み物として再構成したものであることをお断りしておく。参考のために、対応するユーザーガイドのセクションを〈　〉で示した。それから、本稿はVivliostyle Pubで執筆した[^6]。

## フォントを指定する方法

Vivliostyle Pubでは、どのようにしてフォントや文字サイズを指定するのだろうか？　残念ながら、既存ワードプロセッサのようにテキストを選択し、その部分のフォントや文字サイズを指定するようなGUIはまだなく[^7]、別途スタイルシートの中でそれらを指定するという間接的な方法をとっている。

利用できるスタイルシートは下記の3種類だ。

1. **Plain theme：**ブラウザのデフォルトスタイルシートにもとづく必要最低限のもの
2. **Vivliostyle公式theme：**npmパッケージとして公開されているスタイルシート[^8]
3. **Custom theme：**ユーザーが自分で書いたCSSスタイルシート

いずれもActionメニューと呼ばれるプルダウンメニューの中から選択／切り替えができる〈Actionメニューの機能 > Theme（スタイル情報の選択）[^9]〉。

上記1で使用されるフォントは、使っているブラウザで設定されたデフォルトフォントだ。もっともPlain themeは手っ取り早くプレビューを確認するためのものであり、出力は想定していない。

上記2のVivliostyle公式themeのそれぞれで指定されている`font-family`は下記の通りだ。

- Book theme for latin font……`Georgia, serif;`[^10]
- 文庫用のテーマ……`"游明朝", "YuMincho", serif;`[^11]
- Slide theme……`'Noto', 'YuGothic', 'Yu Gothic', 'Meiryo', sans-serif;`[^12]
- Techbook (技術同人誌) theme……`'Neue Frutiger World', 'Verdana',  'Hiragino Sans', sans-serif;`[^13]
- Academic theme……`'Hiragino Mincho ProN', serif;`[^14]


## 利用可能なフォントとそれらを扱う仕組み

Vivliostyle Pubが扱えるフォントは、以下のようにフォントがおかれた場所ごとに3種類に分別できる。〈文書の作成と保存 > フォントの指定方法[^15]〉

- ユーザーのPCにあるローカルフォント（**フォント1**）
- クラウドにインストールされたフォント（**フォント2**）
- Webフォントサービスのフォント（**フォント3**）

上記のうち**フォント2**のリストはユーザーガイド〈文書の作成と保存 > フォントに関する補足情報 > クラウドにインストールされているフォント一覧[^16]〉にまとめてあるので参考にしてほしい。

それでは、上記3種類のフォントを使って、どのようにしてVivliostyle Pubはプレビューしたり、PDF出力したりしているのだろう？　まずプレビューの仕組みを図示してみよう（図2）

![図2　Vivliostyle Pubにおけるプレビューの仕組み](./image/fig-2.png){width=400}

プレビューのために実際に組版をおこなうのがVivliostyle.jsだ。図2をみると、これはユーザーのPC上のフロントエンドにあることが分かる。したがってVivliostyle.jsと同じユーザーのPCにある**フォント1**、及びWebフォントサービスの**フォント3**がプレビューで利用できるわけだ。他方、クラウドにインストールされた**フォント2**はこの図では見当たらない。つまりプレビューでは**フォント2**は利用できないということだ。

次にPDF出力の仕組みを図示してみよう（図3）。

![図3　Vivliostyle PubにおけるPDF出力の仕組み](./image/fig-3.png){width=100%}

PDF出力のために組版をおこなうVivliostyle.jsはクラウド上のバックエンドにある。だからVivliostyle.jsと同じクラウドにある**フォント2**、及びWebフォントサービスの**フォント3**がPDF出力で利用できる。他方、ユーザーのPCにある**フォント1**はこの図には見当たらない。クラウドにあるVivliostyle.jsからは、ユーザのPCにインストールされたフォントは利用しようがないからだ。

ここまでの説明をまとめてみよう。プレビューを担当するユーザーのPC上のVivliostyle.jsは、ローカルフォント（図2：**フォント1**）、及びWebフォントサービスのフォント（図2、図3：**フォント3**）が利用可能だ。

一方、PDF出力を担当するクラウド上のVivliostyle.jsは、クラウドにインストールされたフォント（図3：**フォント2**）、及びWebフォントサービスのフォント（図2、図3：**フォント3**）が利用可能だ。

このような仕組みなので、プレビューとPDF出力は別々の機構として動作しており、互いに連携することもない。プレビューを担当するVivliostyle.jsはPDF出力の際どのようなフォントが使われているのかを知るすべはなく、またPDF出力を担当するVivliostyle.jsはプレビューの際どのようなフォントが使われているのかを知るすべはないのだ。

では、PDF出力の際にクラウドにないフォントが指定された場合、どのようになるのだろう？　これを説明するのが、ユーザーガイドにある下記のリストだ

- 〈文書の作成と保存 > フォントに関する補足情報 > クラウド上のVivliostyle CLIにおける代替フォントルール〉[^17]

この代替フォントルールが適用された結果、プレビューとPDF出力のフォントが不一致になり、ページのズレが発生するという訳なのである。

## プレビューとPDF出力でフォントを一致させる方法

ここまで、Vivliostyle Pubがどのようにフォントを扱っているのかを説明した。つぎに、どのようにすればプレビューとPDF出力のフォントが一致するようになるのかを考えてみよう。

考え方としては、プレビューとPDF出力とで同一のフォントを使うようにすればよい訳だが、その方法は2つある。

1. Webフォントサービスのフォント（**フォント3**）を使う
2. クラウドにインストールされたフォント（**フォント2**）をユーザーのPCにもインストールして指定する

いずれの場合も、Custom themeの中で指定することになる。


Custom themeを作成することで、それにもとづいたプレビューとPDF出力ができます。この時プレビューで使用されるのはユーザーのPCにあるローカルフォント（前掲図1のフォント1）です。一方、PDF出力で使用されるのはクラウドにインストールされたフォント（前掲図2のフォント2）です。

ここで問題になるのは、Custom themeで指定したフォントが、ユーザーのPCかクラウドにしかインストールされていなかった時です。その場合は似たフォントが代替使用されるので、プレビューとPDF出力でフォントが不一致になります。フォントが異なるので、プレビューとPDF出力とでページのズレが発生します。

しかし、クラウドにあるフォントをPCにもインストールし、これをCustom themeで指定すればプレビューとPDF出力とでフォントを一致でき、ページのズレは発生しません。では、クラウドにインストールされているフォントのうち、どのフォントをPCにインストールすれば間違いないのでしょう？

Vivliostyle Pubでは、世界中の言語や文字体系に対応し豊富なウェイトとスタイルをもつNoto fonts 全てを、クラウドにインストールしています。そのうちの日本語ゴシック体フォントであるNoto Sans CJK JP 、および日本語明朝体フォントであるNoto Serif CJK JP を、ユーザーのPCにもインストールするのが最も効率的で効果的です。

要するに、プレビューとPDF出力とでフォントを一致させれば食い違うことはない
その一番簡単な方法はWebフォントサービス（フォント3）を利用することだ
Webサイトの方式には、静的サブセッティングと動的サブセッティングの2つがある
前者はFONT PLUSなど有償Webフォントサービスが採用しており、後者はGoogleフォントが採用している
有償だけあり、前者の方が後者よりも表示速度が速く使い勝手がよい
ただし、有償Webフォントサービスは利用規約によって用途を制限されている点に注意が必要だ
Vivliostyle Pubで無条件にこれらのサービスが利用できるわけではない
また、クラウドにインストールされたフォント（フォント2）と同じものをローカルにインストールし（フォント1）、それを指定するのも有効だ

## おわりに

[^1]: https://github.com/vivliostyle/vivliostyle-pub
[^2]: https://vivliostyle-pub-develop.vercel.app/
[^3]: https://github.com/vivliostyle/vivliostyle.js 
[^4]: プレビューのレスポンス向上のため組版エンジンをローカルにおくのは、Vivliostyle Pubの前身である@spring-raining氏によるViola（https://github.com/violapub/viola ）に由来する。ただし、ViolaにはまだPDFの出力機能は実装されていなかった。
[^5]: https://vivliostyle.github.io/docs-vivliostyle-pub/#/ja/
[^6]: https://github.com/ogwata/tbf13-draft
[^7]: 原稿（Markdownファイル）の一部分だけフォントや文字サイズを変えたい場合、HTMLの`span`要素や`div`要素の属性としてスタイル情報を指定することができる。その他、外部スタイルシートでなく、文書の冒頭で`style`要素を使ってスタイル情報を記述することもできる。いずれにせよUIというようなものでなく、この辺りは今後の課題ではある。
[^8]: https://vivliostyle.github.io/themes/#/ja/gallery
[^9]: https://vivliostyle.github.io/docs-vivliostyle-pub/#/ja/functions-of-the-actions-menu/theme
[^10]: https://www.npmjs.com/package/@vivliostyle/theme-gutenberg
[^11]: https://www.npmjs.com/package/@vivliostyle/theme-bunko
[^12]: https://www.npmjs.com/package/@vivliostyle/theme-slide
[^13]: https://www.npmjs.com/package/@vivliostyle/theme-techbook
[^14]: https://www.npmjs.com/package/@vivliostyle/theme-academic
[^15]: https://vivliostyle.github.io/docs-vivliostyle-pub/#/ja/create-and-save-documents/how-to-specify-fonts
[^16]: https://vivliostyle.github.io/docs-vivliostyle-pub/#/ja/create-and-save-documents/additional-information-on-fonts#%E3%82%AF%E3%83%A9%E3%82%A6%E3%83%89%E3%81%AB%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E3%81%95%E3%82%8C%E3%81%A6%E3%81%84%E3%82%8B%E3%83%95%E3%82%A9%E3%83%B3%E3%83%88%E4%B8%80%E8%A6%A7
[^17]: https://vivliostyle.github.io/docs-vivliostyle-pub/#/ja/create-and-save-documents/additional-information-on-fonts#%E3%82%AF%E3%83%A9%E3%82%A6%E3%83%89%E4%B8%8A%E3%81%AEvivliostyle-cli%E3%81%AB%E3%81%8A%E3%81%91%E3%82%8B%E4%BB%A3%E6%9B%BF%E3%83%95%E3%82%A9%E3%83%B3%E3%83%88%E3%83%AB%E3%83%BC%E3%83%AB


